# ТЕХНИЧЕСКОЕ ЗАДАНИЕ
## Платформа для создания и управления чат-ботами

**Версия документа**: 2.0  
**Дата создания**: 23.09.2025  
**Статус**: Финальная версия на основе реализованной системы  

---

## 1. ОБЩИЕ СВЕДЕНИЯ

### 1.1 Наименование системы
**Chatbot Platform** - корпоративная платформа для создания, управления и выполнения сценариев чат-ботов с поддержкой визуального конструктора и микросервисной архитектуры.

### 1.2 Назначение системы
Платформа предназначена для:
- Создания интеллектуальных чат-ботов без программирования
- Управления сценариями диалогов через визуальный интерфейс
- Обработки до 1 миллиона диалогов в день
- Интеграции с внешними системами и AI-сервисами
- Мониторинга и аналитики взаимодействий с пользователями

### 1.3 Основания для разработки
- Необходимость автоматизации клиентского сервиса
- Требование поддержки высоких нагрузок (1M диалогов/день)
- Потребность в гибком конструкторе сценариев
- Требования отказоустойчивости (99.9% SLA)

### 1.4 Плановые сроки
- **Разработка**: Завершена
- **Тестирование**: В процессе
- **Внедрение**: Q4 2025
- **Сопровождение**: Постоянно

---

## 2. АРХИТЕКТУРНЫЕ ТРЕБОВАНИЯ

### 2.1 Общая архитектура
**Микросервисная архитектура** с разделением на независимые сервисы:

#### 2.1.1 Backend сервисы (Java 21 + Quarkus 3.24.3)
1. **API Gateway** (порт 8090) - единая точка входа
2. **Chat Service** (порт 8091) - управление диалогами и WebSocket
3. **Orchestrator** (порт 8092) - выполнение сценариев
4. **Scenario Service** (порт 8093) - управление сценариями
5. **Module Service** (порт 8094) - переиспользуемые модули
6. **NLU Service** (порт 8095) - обработка естественного языка
7. **STT Service** (порт 8096) - преобразование речи в текст
8. **LLM Service** (порт 8097) - интеграция с языковыми моделями

#### 2.1.2 Frontend приложение
- **React 18** + **TypeScript** + **Material-UI**
- **React Flow** для визуального редактора сценариев
- **WebSocket** для real-time коммуникации

#### 2.1.3 Базы данных
- **PostgreSQL 15** - основное хранилище (порт 5432)
- **Redis 7** - кэширование и сессии (порт 6380)

### 2.2 Технологический стек

#### Backend
- **Java**: 21 (LTS)
- **Quarkus**: 3.24.3
- **Quarkus REST**: для REST API
- **Quarkus WebSockets**: для real-time коммуникации
- **Quarkus Hibernate ORM**: для работы с БД
- **Quarkus Reactive**: для реактивного программирования
- **GraalVM/Nashorn**: для выполнения JavaScript в сценариях
- **Docker**: контейнеризация
- **Maven**: Сщсистема сборки

#### Frontend
- **React**: 19.1.1
- **TypeScript**: 5.x
- **Material-UI**: 6.x
- **React Flow**: 12.x для визуального редактора
- **Zustand**: управление состоянием
- **TanStack Query**: работа с API
- **Socket.IO**: WebSocket коммуникация

#### Инфраструктура
- **PostgreSQL**: 15
- **Redis**: 7
- **Docker Compose**: локальная разработка
- **Kubernetes**: продакшн развертывание
- **Nginx**: балансировка нагрузки

---

## 3. ФУНКЦИОНАЛЬНЫЕ ТРЕБОВАНИЯ

### 3.1 Конструктор сценариев

#### 3.1.1 Визуальный редактор
- **Drag-and-drop интерфейс** на базе React Flow
- **8 типов блоков сценариев**:
  1. `announce` - объявление/сообщение
  2. `ask` - вопрос пользователю
  3. `parse` - парсинг ответа
  4. `api-request` - вызов внешнего API
  5. `llm-call` - обращение к языковой модели
  6. `wait` - ожидание
  7. `condition` - условный переход
  8. `sub-flow` - вложенный сценарий

#### 3.1.2 Управление сценариями
- **Создание/редактирование** сценариев через UI
- **Версионирование** с разделением test/production
- **Импорт/экспорт** в JSON/YAML формате
- **Валидация** сценариев при сохранении
- **Каталог сценариев** с расширенным поиском

#### 3.1.3 Мультиязычность
- **Основной язык**: украинский
- **Fallback язык**: английский
- **Автоматическое переключение** на основе языка пользователя

### 3.2 Выполнение сценариев

#### 3.2.1 Orchestrator Engine
- **Интерпретация** JSON сценариев
- **Выполнение JavaScript** кода в блоках (GraalVM)
- **Управление контекстом** диалога
- **Переходы между блоками** по условиям
- **Обработка ошибок** и fallback сценарии

#### 3.2.2 Поддержка каналов
- **Web виджет** с WebSocket
- **REST API** для интеграций
- **Webhook** для внешних систем
- **Расширяемость** для новых каналов

### 3.3 NLU и AI интеграции

#### 3.3.1 Обработка естественного языка
- **Intent Recognition** - определение намерений
- **Entity Extraction** - извлечение сущностей
- **Sentiment Analysis** - анализ тональности
- **Confidence Score** - уровень уверенности

#### 3.3.2 Интеграция с LLM
- **OpenAI GPT** интеграция
- **Google Cloud AI** поддержка
- **Azure OpenAI** совместимость
- **Кэширование ответов** для оптимизации

#### 3.3.3 Speech-to-Text
- **Распознавание речи** в реальном времени
- **Поддержка форматов**: WAV, MP3, OGG
- **Мультиязычность**: украинский, английский

### 3.4 Аналитика и мониторинг

#### 3.4.1 Метрики диалогов
- **Количество диалогов** в реальном времени
- **Время выполнения** сценариев
- **Conversion rate** по сценариям
- **Популярные интенты** и сценарии

#### 3.4.2 Технические метрики
- **Производительность сервисов**
- **Использование ресурсов**
- **Ошибки и исключения**
- **SLA мониторинг** (99.9% uptime)

#### 3.4.3 Дашборды
- **Executive dashboard** - KPI для руководства
- **Operations dashboard** - для DevOps команды
- **Analytics dashboard** - для аналитиков
- **Developer dashboard** - для разработчиков

---

## 4. НЕФУНКЦИОНАЛЬНЫЕ ТРЕБОВАНИЯ

### 4.1 Производительность
- **Пропускная способность**: 1,000,000 диалогов в день
- **Пиковая нагрузка**: до 3x от средней
- **Время отклика API**: < 200ms (95 перцентиль)
- **Время выполнения сценария**: < 2 секунды

### 4.2 Масштабируемость
- **Горизонтальное масштабирование** всех сервисов
- **Auto-scaling** на основе нагрузки
- **Поддержка до 1,000,000 сценариев**
- **Партиционирование БД** по дате

### 4.3 Отказоустойчивость
- **SLA**: 99.9% доступности
- **Geo-failover**: автоматическое переключение регионов
- **Время восстановления**: < 5 минут
- **Graceful degradation** при частичных сбоях

### 4.4 Безопасность
- **OAuth 2.0** аутентификация
- **RBAC** (Role-Based Access Control)
- **HTTPS/TLS** для всех соединений
- **Шифрование данных** в БД
- **Audit logging** всех действий

### 4.5 Совместимость
- **Браузеры**: Chrome 90+, Firefox 88+, Safari 14+
- **Мобильные устройства**: iOS 14+, Android 10+
- **API версионирование**: /api/v1/, /api/v2/
- **Обратная совместимость** сценариев

---

## 5. СХЕМА БАЗЫ ДАННЫХ

### 5.1 Основные таблицы

#### users - Пользователи системы
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(255) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role user_role NOT NULL DEFAULT 'EDITOR',
    is_active BOOLEAN DEFAULT true,
    last_login_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### scenarios - Сценарии чат-ботов
```sql
CREATE TABLE scenarios (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    chatbot_id UUID REFERENCES chatbot_instance(id),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    category VARCHAR(100),
    tags TEXT[],
    language VARCHAR(10) NOT NULL DEFAULT 'uk',
    fallback_language VARCHAR(10) DEFAULT 'en',
    block_types TEXT[],
    complexity_level INTEGER DEFAULT 1,
    is_active BOOLEAN DEFAULT true,
    current_version INTEGER DEFAULT 1,
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    search_vector tsvector
);
```

#### dialogs - История диалогов
```sql
CREATE TABLE dialogs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id VARCHAR(255) NOT NULL,
    scenario_id UUID REFERENCES scenarios(id),
    user_message TEXT,
    bot_response TEXT,
    intent VARCHAR(100),
    confidence DECIMAL(3,2),
    execution_time INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 5.2 Индексы для производительности
- **Полнотекстовый поиск** по сценариям
- **Партиционирование** диалогов по дате
- **Составные индексы** для аналитики
- **GIN индексы** для JSONB полей

---

## 6. API СПЕЦИФИКАЦИЯ

### 6.1 REST API Endpoints

#### Scenario Management
```
GET    /api/v1/scenarios              - Список сценариев
POST   /api/v1/scenarios              - Создание сценария
GET    /api/v1/scenarios/{id}         - Получение сценария
PUT    /api/v1/scenarios/{id}         - Обновление сценария
DELETE /api/v1/scenarios/{id}         - Удаление сценария
POST   /api/v1/scenarios/{id}/export  - Экспорт сценария
POST   /api/v1/scenarios/import       - Импорт сценария
```

#### Dialog Execution
```
POST   /api/v1/dialogs/start          - Начало диалога
POST   /api/v1/dialogs/{id}/message   - Отправка сообщения
GET    /api/v1/dialogs/{id}/history   - История диалога
POST   /api/v1/dialogs/{id}/end       - Завершение диалога
```

#### Analytics
```
GET    /api/v1/analytics/metrics      - Основные метрики
GET    /api/v1/analytics/scenarios    - Аналитика по сценариям
GET    /api/v1/analytics/intents      - Статистика интентов
GET    /api/v1/analytics/performance  - Производительность
```

### 6.2 WebSocket API
```
ws://host:port/ws/chat/{sessionId}
```

**События**:
- `message` - новое сообщение
- `typing` - индикатор печати
- `scenario_change` - смена сценария
- `error` - ошибка выполнения

---

## 7. РАЗВЕРТЫВАНИЕ И ЭКСПЛУАТАЦИЯ

### 7.1 Требования к инфраструктуре

#### Минимальные требования
- **CPU**: 8 cores
- **RAM**: 16 GB
- **Storage**: 100 GB SSD
- **Network**: 1 Gbps

#### Рекомендуемые требования
- **CPU**: 16 cores
- **RAM**: 32 GB
- **Storage**: 500 GB SSD
- **Network**: 10 Gbps

### 7.2 Docker Compose (локальная разработка)
```bash
# Запуск всей платформы
docker-compose -f docker-compose-ports.yml up -d

# Проверка статуса
docker-compose ps

# Просмотр логов
docker-compose logs -f
```

### 7.3 Kubernetes (продакшн)
```bash
# Развертывание
kubectl apply -f infrastructure/

# Проверка статуса
kubectl get pods -n chatbot-platform

# Масштабирование
kubectl scale deployment orchestrator --replicas=3
```

### 7.4 Мониторинг
- **Health checks**: `/actuator/health` для всех сервисов
- **Metrics**: Prometheus + Grafana
- **Logging**: ELK Stack
- **Alerting**: AlertManager

---

## 8. БЕЗОПАСНОСТЬ

### 8.1 Аутентификация и авторизация
- **OAuth 2.0** с внешним провайдером
- **JWT токены** с refresh механизмом
- **Роли**: ADMIN, EDITOR, VIEWER
- **Сессионное управление** через Redis

### 8.2 Защита данных
- **HTTPS** для всех соединений
- **Шифрование паролей** (bcrypt)
- **Маскирование PII** в логах
- **GDPR compliance** готовность

### 8.3 Сетевая безопасность
- **Firewall** правила
- **Network policies** в Kubernetes
- **Rate limiting** для API
- **CORS** настройки

---

## 9. ТЕСТИРОВАНИЕ

### 9.1 Виды тестирования
- **Unit тесты** - покрытие > 80%
- **Integration тесты** - API endpoints
- **E2E тесты** - пользовательские сценарии
- **Load тесты** - нагрузочное тестирование
- **Security тесты** - проверка уязвимостей

### 9.2 Тестовые данные
- **Демо сценарии** для тестирования
- **Mock внешние API** для изоляции
- **Синтетические диалоги** для нагрузки
- **Регрессионные тесты** для CI/CD

---

## 10. ДОКУМЕНТАЦИЯ

### 10.1 Техническая документация
- **API документация** (OpenAPI/Swagger)
- **Архитектурные диаграммы**
- **Схема базы данных**
- **Руководство по развертыванию**

### 10.2 Пользовательская документация
- **Руководство администратора**
- **Инструкция по созданию сценариев**
- **FAQ и troubleshooting**
- **Видео-туториалы**

---

## 11. ИНТЕГРАЦИИ И ВНЕШНИЕ СИСТЕМЫ

### 11.1 Корпоративные интеграции
- **CRM интеграция**: планируется в будущих версиях
- **OAuth 2.0**: единственный метод авторизации
- **Корпоративные API**: универсальная поддержка через HTTP блоки сценариев
- **Гибкая архитектура**: поддержка любых REST/GraphQL API

### 11.2 AI/ML сервисы
**Поддерживаемые LLM модели**:
- OpenAI GPT-4/GPT-3.5
- Google Gemini Pro/Ultra
- Anthropic Claude 3
- Azure OpenAI Service

**NLU модуль**:
- Собственная модель NLU как отдельный микросервис
- Возможность замены без изменения архитектуры
- Поддержка украинского и английского языков
- Intent recognition + Entity extraction

### 11.3 Каналы коммуникации
- **Основной канал**: собственный веб-чат
- **Телефонные звонки**: интеграция как внешний модуль
- **API интеграция**: система вызывается для генерации ответов
- **Контекстная обработка**: сохранение истории диалога

## 12. ПРОИЗВОДСТВЕННЫЕ ТРЕБОВАНИЯ

### 12.1 Облачная инфраструктура
**Предпочтительные провайдеры**:
- **AWS EKS** (приоритет)
- **Google GKE** (альтернатива)

**Регионы для geo-failover**:
- eu-west-3 (Париж) - основной
- eu-west-4 (Милан) - резервный

### 12.2 Производительность
**Базовая нагрузка**: 1M диалогов/день
**Пиковая нагрузка**: 3M диалогов/день (60M запросов/день)
**Распределение нагрузки**: синусоида с пиком в 13:00
**Критичная метрика**: CPU utilization

**Время восстановления**:
- RTO: 30 секунд - 1 минута
- RPO: последние 10 версий сценариев

### 12.3 Безопасность
- **Изолированная среда**: корпоративная сеть
- **Персональные данные**: данные клиентов (базовая защита)
- **Шифрование**: стандартное HTTPS
- **Аудит**: не требуется для MVP

## 13. ПОЛЬЗОВАТЕЛЬСКИЙ ОПЫТ

### 13.1 Совместная работа
- **Collaborative editing**: поддержка совместного редактирования ИЛИ изоляция работы
- **Система комментариев**: обязательная функция для review сценариев
- **Версионирование**: с возможностью отката к любой из 10 последних версий

### 13.2 Роли пользователей
**Начальная реализация**: общая роль с полными правами
**Будущее развитие**: детальное разделение ролей и прав

### 13.3 Аналитика и отчетность
**Критичные метрики**:
- Количество одновременных диалогов (каждую минуту)
- Статистика по тематикам и интентам
- Детализация ошибок и исключений
- Максимальная детализация всех метрик

**A/B тестирование**: поддержка тестирования разных версий сценариев

**Real-time KPI**: соотношение ошибок к общему количеству диалогов

## 14. ПЛАН РАЗВИТИЯ

### 14.1 Ближайшие задачи (Q4 2025)
- [ ] Завершение тестирования всех сервисов
- [ ] Интеграция с OAuth 2.0
- [ ] Оптимизация под пиковые нагрузки (60M запросов/день)
- [ ] Подготовка к продакшн развертыванию в AWS EKS

### 14.2 Среднесрочные цели (Q1-Q2 2026)
- [ ] CRM интеграция
- [ ] Расширенная аналитика с детализацией
- [ ] Система комментариев и review
- [ ] Collaborative editing функционал

### 14.3 Долгосрочные планы (2026+)
- [ ] Детальная система ролей
- [ ] Расширение языковой поддержки
- [ ] AI-powered оптимизация сценариев
- [ ] Advanced monitoring и alerting

---

## 12. ПРИЛОЖЕНИЯ

### 12.1 Глоссарий терминов
- **Сценарий** - последовательность блоков для диалога
- **Интент** - намерение пользователя
- **Сущность** - извлеченная из текста информация
- **Контекст** - состояние диалога
- **Fallback** - резервный сценарий при ошибках

### 12.2 Список сокращений
- **API** - Application Programming Interface
- **NLU** - Natural Language Understanding
- **STT** - Speech-to-Text
- **LLM** - Large Language Model
- **SLA** - Service Level Agreement
- **RBAC** - Role-Based Access Control

---

**Документ подготовлен**: 23.09.2025  
**Версия**: 2.0  
**Статус**: Утверждено к реализации  
**Следующий пересмотр**: 01.01.2026
